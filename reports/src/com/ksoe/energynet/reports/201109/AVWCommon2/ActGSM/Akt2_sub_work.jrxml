<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="Akt2_sub_work" pageWidth="535" pageHeight="518" orientation="Landscape" columnWidth="535" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0">
	<property name="ireport.scriptlethandling" value="0"/>
	<property name="ireport.encoding" value="UTF-8"/>
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<import value="net.sf.jasperreports.engine.*"/>
	<import value="java.util.*"/>
	<import value="net.sf.jasperreports.engine.data.*"/>
	<parameter name="PcodeAkt" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new Integer(500000009)]]></defaultValueExpression>
	</parameter>
	<parameter name="Pperiod" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["Виконано робіт "]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[/*выборка километров и часов для актов по перевозке
определять если итем транспорта есть в связке entravlshttm2trnsprttm тогда брать километры из итема тупевого листа
путем сумирование разницы sum(speedometrfinal - speedometrstart) иначе брать из endistance */
/*Select  tk.name as tname
          , tk.techkartnumber
          , sum(d.distance) as km
          , sum(ti.countworkfact) as hour
         from  enact2enplanwork ena2 ,
                  tktechcard tk ,
                  enplanworkitem eni ,
                  entransportitem ti left join endistance d  on
                 d.transportitemrefcode = ti.code
where ena2.actrefcode =  500005657
  and ena2.plancode = eni.planrefcode
  and eni.kartarefcode = tk.code
  and coalesce(eni.countgen , 0) <> 0
  and ti.planitemrefcode = eni.code


  group by tk.name
        , tk.techkartnumber */

/*выборка километров и часов для актов по перевозке
определять если итем транспорта есть в связке entravlshttm2trnsprttm тогда брать километры из итема тупевого листа
путем сумирование разницы sum(speedometrfinal - speedometrstart) иначе брать из endistance */
select tname
          , techkartnumber
          , sum(km) as km
           , sum(hour) as hour from
(
select  tname
          , techkartnumber
          , case when aaa.check = 1 then coalesce(aaa.kmfromshit) else   coalesce(km)  end as km
           , hour
          -- , kmfromshit
           ,aaa.check
           , tricode
          FROM (

Select
            tk.name||(case when substr(tk.name, length(tk.name)) <> '.' then '.' else '' end)||' K = '||cast(coeff.coefficient as varchar) as tname
          , tk.techkartnumber
          , (select  sum(dd.distance) from  endistance dd  where dd.transportitemrefcode = ti.code ) as  km
          , ti.countworkfact as hour
          , shit.speedometerfinal  -  shit.speedometerstart as  kmfromshit
          , case when (select count(prov.code) from entravlshttm2trnsprttm prov where prov.transportitemrefcode = ti.code    ) > 0 then 1 else 0 end  as check
      ,  ti.code as tricode
         from  enact2enplanwork ena2 ,
                  tktechcard tk ,
                  enplanworkitem eni ,
/*Подсчитывание коэффициента загрузки персонала*/
	(select
		pi.planrefcode,
		acpw.actrefcode,
		pi.kartarefcode,
		coalesce((case
            	when min(ko.koef) = 0
    		then min(ko.koef)
		else
			(case
                    	when sum(case when ko.koef < 0  then 1 else 0 end) = 0 then 1 else -1 END)*
    				round(cast(exp(sum(ln(case when coalesce(ko.koef,0) = 0 then 1 else abs(ko.koef) end))) as decimal),2)
		end), 1) as coefficient
	from
        	enplanworkitem as pi
        	inner join enact2enplanwork as acpw on pi.planrefcode = acpw.plancode
        	left join enplanworkitem2tkkoef as piko on pi.code = piko.planworkitemrefcode
		left join tktechcardsourcekoef as ko on piko.sourcekoefcode = ko.code
	where coalesce(pi.countgen,0) <> 0
	group by
		pi.kartarefcode,
		pi.planrefcode,
		acpw.actrefcode) as coeff, /* Конец подсчета коэффициента загрузки персонала*/
                  entransportitem ti left join endistance d  on
                 d.transportitemrefcode = ti.code
                                            left join entravlshttm2trnsprttm tr2trit   left join  entravelsheetitem   shit        on
                    shit.code = tr2trit.travelsheetitemrefcode   on
                 ti.code =  tr2trit.transportitemrefcode

where
  ena2.actrefcode = $P{PcodeAkt}
  and ena2.plancode = eni.planrefcode
  and eni.kartarefcode = tk.code
  and coalesce(eni.countgen , 0) <> 0
  and ti.planitemrefcode = eni.code
  and coeff.kartarefcode = eni.kartarefcode
  and coeff.planrefcode = eni.planrefcode
  and coeff.actrefcode = ena2.actrefcode
) aaa
  group by  tname
          , techkartnumber
          , km
          , hour
          , kmfromshit    , aaa.check, tricode
) qq
 group by  tname
          , techkartnumber]]>
	</queryString>
	<field name="tname" class="java.lang.String"/>
	<field name="techkartnumber" class="java.lang.String"/>
	<field name="km" class="java.math.BigDecimal"/>
	<field name="hour" class="java.math.BigDecimal"/>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="55" splitType="Stretch">
			<staticText>
				<reportElement key="staticText-1" x="0" y="0" width="30" height="40"/>
				<box>
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Top">
					<font fontName="Times New Roman" size="7" isBold="true" pdfFontName="timesbd.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<text><![CDATA[№ п.п]]></text>
			</staticText>
			<staticText>
				<reportElement key="staticText-2" x="30" y="0" width="355" height="40"/>
				<box>
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Top">
					<font fontName="Times New Roman" size="7" isBold="true" pdfFontName="timesbd.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<text><![CDATA[Найменування робіт]]></text>
			</staticText>
			<staticText>
				<reportElement key="staticText-5" x="385" y="20" width="75" height="20"/>
				<box>
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Top">
					<font fontName="Times New Roman" size="7" isBold="true" pdfFontName="timesbd.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<text><![CDATA[км.]]></text>
			</staticText>
			<staticText>
				<reportElement key="staticText-7" x="460" y="20" width="75" height="20"/>
				<box>
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Top">
					<font fontName="Times New Roman" size="7" isBold="true" pdfFontName="timesbd.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<text><![CDATA[маш.год.]]></text>
			</staticText>
			<textField isStretchWithOverflow="true" pattern="###0.00" isBlankWhenNull="true">
				<reportElement key="textField-9" stretchType="RelativeToTallestObject" mode="Transparent" x="385" y="0" width="150" height="20" isPrintWhenDetailOverflows="true" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Top" rotation="None">
					<font fontName="Times New Roman" size="7" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="times.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA[$P{Pperiod}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement key="textField-10" mode="Transparent" x="0" y="40" width="535" height="15" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle" rotation="None">
					<font fontName="Times New Roman" size="10" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="times.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA["Обсяг виконаних робіт"]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageHeader>
		<band splitType="Stretch"/>
	</pageHeader>
	<columnHeader>
		<band splitType="Stretch"/>
	</columnHeader>
	<detail>
		<band height="10" splitType="Stretch">
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement key="textField-1" stretchType="RelativeToTallestObject" mode="Transparent" x="0" y="0" width="30" height="10" forecolor="#000000" backcolor="#FFFFFF"/>
				<box leftPadding="1" bottomPadding="4" rightPadding="1">
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Top" rotation="None">
					<font fontName="Times New Roman" size="8" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="times.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA[$V{REPORT_COUNT}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement key="textField-2" stretchType="RelativeToTallestObject" mode="Transparent" x="30" y="0" width="355" height="10" forecolor="#000000" backcolor="#FFFFFF"/>
				<box leftPadding="1" bottomPadding="4" rightPadding="1">
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Top" rotation="None">
					<font fontName="Times New Roman" size="8" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="times.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{tname}+"                "]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="###0.000" isBlankWhenNull="true">
				<reportElement key="textField-5" stretchType="RelativeToTallestObject" mode="Transparent" x="385" y="0" width="75" height="10" forecolor="#000000" backcolor="#FFFFFF"/>
				<box leftPadding="1" bottomPadding="4" rightPadding="1">
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Top" rotation="None">
					<font fontName="Times New Roman" size="8" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="times.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{km}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="###0.00" isBlankWhenNull="true">
				<reportElement key="textField-6" stretchType="RelativeToTallestObject" mode="Transparent" x="460" y="0" width="75" height="10" forecolor="#000000" backcolor="#FFFFFF"/>
				<box leftPadding="1" bottomPadding="4" rightPadding="1">
					<topPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Top" rotation="None">
					<font fontName="Times New Roman" size="8" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="times.ttf" pdfEncoding="Cp1251" isPdfEmbedded="true"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{hour}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band splitType="Stretch"/>
	</pageFooter>
	<summary>
		<band splitType="Stretch"/>
	</summary>
</jasperReport>
